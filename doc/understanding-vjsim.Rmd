---
title: "Understanding and using `vjsim`"
author: "Mladen JovanoviÄ‡"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{understanding-vjsim}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 6,
  fig.height = 4,
  dpi = 300,
  out.width = "90%",
  auto_pdf = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

The goal of `vjsim` is to simulate a simple vertical jump model to provide an educational tool for helping in understanding elementary biomechanical concepts and jump profiles used in sport science.

Vertical jump (actually the **squat jump** since there is no *counter-movement action*[^countermovement]) is represented with a simple mechanical model (see Figure). 

[^countermovement]: Vertical jump can be done in multiple ways. One way is to dip down and then rebound as high as possible. This vertical jump containts countermovement action which increase vertical jump height due to various mechanism (which are not in our interest for this simulation). Other way is to squat down, hold the position for a second or two, and then explode upward without any dip. This can be considered purely *concentric* jump, and it is usually termed *squat jump* to be differentiated from the countermovement jump. The hands are usually held at the hip, without allowing any swing. In `vjsim` only the squat jump is simulated and analyzed. Thus, when I refer to vertical jump, I refer to a static squat jump with arms continuously held at the hips.

```{r, echo=FALSE, mechanical-model, fig.cap="Mechanical model that is used to represent vertical jump"}
knitr::include_graphics(path = "mechanical-model.png")
```

Athlete is represented with a simple object (with a `mass` (measured using kilograms (kg)) and `weight`; where $weight = mass \times 9.81$ Newtons (N)), that needs to be propelled over `Push-off Distance` (measured in meters; usually around 0.4m for human subjects) by the action of the `Force Generator`. Vertical jump height is the height reached *not* taking `Push-off Distance` into account and can be calculated with a simple ballistic equation from the `Push-off Velocity` (measured in meters per second (m/s)):

$$
Height = \frac{v_{takeoff}^2}{2\times9.81}(m)
$$

Initial velocity is assumed to be 0m/s, angle is assumed to be 90degrees, gravity constant is 9.81$m/s^2$. For example, if `Push-off Velocity` is 3m/s, the calculated height reached is equal to:

$$
Height = \frac{v_{takeoff}^2}{2\times9.81}(m)
$$

$$
Height = \frac{3^2}{19.62}(m)
$$
$$
Height = \frac{9}{19.62}(m)
$$
$$
Height = 0.46(m)
$$

Please note that the body weight (or the object mass) doesn't influence height reached. What bodyweight influences, though, is `Push-off Velocity` reached given characteristics of the `Force Generator`. 

# Force Generator

`Force Generator` is believed to be some *entity* in the muscles and lower body with distinct characteristics[^distinct_characteristics]. In `vjsim`, these characteristics are explained with three relationships: (1) force-length, (2) force-time, and (3) force-velocity relationships (see Figure). 

[^distinct_characteristics]: This is generally something I can't entirely agree with 100% and will be the topic of the simulation analyses and discussions in another document. 

```{r, echo=FALSE, force-generator, fig.cap="Force Generator components"}
knitr::include_graphics(path = "force-generator-components.png")
```

## Force-Length Relationship

`Force Generator` cannot express full force across the `Push-off Distance`. Assuming *isometric* conditions (i.e. we move the `Force Generator` at a particular position alongside `Push-off Distance` and hold it *firmly* there), *potential force* that can be expressed depends on Force-Length relationship. I've used *potential force* intentionally because this force represents isometric force that can be expressed in the isometric or static conditions (i.e. immovable object and enough time to generate it). In the dynamic conditions, this force will depend on the current velocity and time (due to Force-Time and Force-Velocity relationship). 

Force-Length relationship is expressed as a percentage of *max force* across `Push-off Distance`. The following Figure contains few examples how this relationship is modeled in `vjsim`, using the `vjsim::fgen_force_length` function.

```{r setup}
# Install vjism if you haven't but running the following commands
# install.packages("devtools")
# devtools::install_github("mladenjovanovic/vjsim")

library(vjsim)
library(tidyverse)
```

```{r force-length-relationship, fig.cap="Force-Length relationhsip"}
parameters <- expand.grid(
  current_distance = seq(0, 0.7, length.out = 1000),
  start_force = c(0.6, 0.8),
  end_force = 0,
  threshold = c(0.8, 0.9),
  push_off_distance = c(0.4, 0.7)
)

force_length <- parameters %>%
  mutate(
    force_percentage = vjsim::fgen_force_length(
      current_distance = current_distance,
      start_force = start_force,
      end_force = end_force,
      threshold = threshold,
      push_off_distance = push_off_distance
    ),
    threshold = factor(threshold),
    start_force = factor(paste("Start force =", start_force)),
    push_off_distance = factor(paste("Push-off =", push_off_distance)),
  )

ggplot(
  force_length,
  aes(
    x = current_distance,
    y = force_percentage,
    group = threshold,
    color = threshold
  )
) +
  theme_minimal() +
  geom_line() +
  facet_grid(push_off_distance ~ start_force) +
  xlab("Distance (m)") +
  ylab("Force percentage")
```

The parameters of the Force-Length relationship, and thus `vjsim::fgen_force_length` as well, are *start force* (from 0.5 to 1; default 0.8), *end force* (from 0.5 to 1; default is 0), *threshold* (from 0.8 to 1; default is 0.95), and *push off distance* (from 0.2m to 0.7m; default 0.4m).

## Force-Time Relationship

`Force Generator` cannot express full force instantaneously. It takes time to generate force. Let's assume that the *max force* is 3,000N, and that `Force Generator` is held at a particular position on the `Push-off Distance` where 90% of this *max force* can be potentially expressed (i.e. 2,700N). Let's assume that the *initial force* is 0N and 735N. Why *initial force* of 735N? Because `Force Generator` needs to generate force at t=0 equal to the bodyweight of the athlete, in this case, around 75kg. The figure below depicts a few examples of the Force-Time relationships using the `vjsim::fgen_force_time` function.

```{r force-time-relationship, fig.cap="Force-Time relationhsip"}
parameters <- expand.grid(
  current_time = seq(0, 0.6, length.out = 1000),
  initial_force = c(0, 735),
  max_force = 2700,
  time_to_max_force = c(0.3, 0.5)
)

force_time <- parameters %>%
  mutate(
    force = vjsim::fgen_force_time(
      current_time = current_time,
      initial_force = initial_force,
      max_force = max_force,
      time_to_max_force = time_to_max_force
    ),
    initial_force = factor(initial_force),
    time_to_max_force = factor(paste("Time to max force =", time_to_max_force)),
  )

ggplot(
  force_time,
  aes(
    x = current_time,
    y = force,
    group = initial_force,
    color = initial_force
  )
) +
  theme_minimal() +
  geom_line() +
  facet_wrap(~time_to_max_force) +
  xlab("Time (s)") +
  ylab("Force (N)")
```

The parameters of the Force-Time relationship, and thus `vjsim::fgen_force_time` as well, are *initial force* (default is 0N), *max force* (which is *potential force* that can potentially be generated based on the Force-Length relationship), and *time to max force* (default is 0.3). **PLEASE NOTE** that the time to max force depends on both the *time to max force* parameter and *initial force*. For example, if it takes 0.3 seconds to reach 2,700N from 0N (initial force), it will take a proportionally shorter time if one starts from higher *initial force*. This is one of the assumptions in the `vjsim`.

## Force-Velocity Relationship

So far, the Force-Length and Force-Time relationships assumed *static* conditions or v=0m/s. In plain English, we used *isometric* or static conditions by holding the `Force Generator` and probing it. But once the `Force Generator` stars moving, there is an additional component that is modeled with the *viscous* properties:

$$
Force_{viscuous} = -k \times v
$$

In *real-life*, the faster the muscles (i.e. `Force Generator`) are shortening, the less for they can exert. The mechanism behind this is not really understood (pardon my ignorance if I am wrong), but it is hypothesized that it is due to the shortening of the time *cross-bridges* in the muscle cell have to *pull*. Another explanation might be an increase in the viscous forces inside the muscle, that resist movement. Anyway, this *phenomenological* characteristic (i.e. muscle or `Force Generator` decrease force production as velocity increases) can be modeled with the above equation. The higher the $k$ parameter, the bigger the resistance. 

Let's assume that the *max force* is 2700N, and that $k=675$. In *unconstrained* conditions (hypothetical conditions where `Force Generator` has unlimited `Push-off Distance` and **zero external resistance**; i.e. mass and weight; or is being moved by specialized aparatus at particular velocity where force generated is 0) the *max velocity* is achieve when *max force* becomes equal to viscous force:

$$
Force_{max} = -Force_{viscous}
$$

$$
2700 = k \times v
$$

$$
2700 = 675 \times v
$$

$$
v = \frac{2700}{675}
$$

$$
v = 4 (m/s)
$$

In other words:

$$
v_{max} = \frac{F_{max}}{k}
$$

Rather than using $k$, we can use *max velocity* as a parameter of this `Force Generator` component. *Max velocity* and *max force* represent *inherent* characteristics of the `Force Generator`. Please note that *max velocity* parameter represents maximal velocity `Force Generator` in *unconstrained* environment (unlimited `Push-off Distance` and no external resistance; i.e. force).

Using the `vjsim::fgen_force_velocity` function, we can get viscous or opposing force inside the `Force Generator`. 

```{r force-velocity-relationship, fig.cap="Force-Velocity relationhsip"}
parameters <- expand.grid(
  current_velocity = seq(0, 4.5, length.out = 1000),
  max_force = c(2000, 2500, 3000),
  max_velocity = c(2, 3, 4)
)

force_velocity <- parameters %>%
  mutate(
    force = vjsim::fgen_force_velocity(
      current_velocity = current_velocity,
      max_force = max_force,
      max_velocity = max_velocity
    ),
    max_velocity = factor(max_velocity),
    max_force_label = factor(paste("Max Force = ", max_force))
  )

ggplot(
  force_velocity,
  aes(
    x = current_velocity,
    y = force,
    group = max_velocity,
    color = max_velocity
  )
) +
  theme_minimal() +
  geom_hline(aes(yintercept = -max_force), linetype = "dashed") +
  geom_line() +
  facet_wrap(~max_force_label) +
  xlab("Velocity (m/s)") +
  ylab("Viscous Force (N)")
```

The above Figure represents viscous force generate at particular velocities. Assuming *unconstrained* conditions (i.e. unlimited `Push-off Distance`), we are interested in estimating maximal velocity that can be achieved when `Force Generator` faces some resistance. Since we are assuming *unconstrained* conditions, the mass of the resistance is not important (due unlimited `Push-off Distance` to accelerate), but only the facing external resisting force. The `Force Generator` faces two opposing forces then: external resistance force and viscous force (which is internal or intrinsic part of the  `Force Generator` itself). Maximal velocity is achieved when the sum of forces is equal to zero:

$$
Force_{max} + Force_{viscous} + Force_{external} = 0
$$

Please note that the $Force_{viscous}$ and $Force_{external}$ are in the opposite direction of $Force_{max}$. Which makes the following equation:

$$
Force_{max} - Force_{viscous} - Force_{external} = 0
$$

Or by shifting the Forces around:

$$
Force_{viscous} = Force_{max} - Force_{external}
$$

$$
(k \times v) = Force_{max} - Force_{external}
$$

$$
v = \frac{Force_{max} - Force_{external}}{k}
$$

If we use the equation $v_{max} = \frac{F_{max}}{k}$ to get $k$, we get the following

$$
v = \frac{Force_{max} - Force_{external}}{\frac{Force_{max}}{v_{max}}}
$$

Assuming few combinations of *max force* and *max velocity* of the `Force Generator`, depending on the level of facing external resistance (N), we can calculate velocity ($v$) that can be hypothetically reached in the *unconstrained* conditions. You can use the above equation, or the `vjsim::fgen_get_velocity` function.

```{r}
parameters <- expand.grid(
  external_resistance = seq(0, 3000, length.out = 1000),
  max_force = c(2000, 2500, 3000),
  max_velocity = c(2, 3, 4)
)

velocity_reached <- parameters %>%
  filter(external_resistance < max_force) %>%
  mutate(
    velocity_reached = vjsim::fgen_get_velocity(
      external_resistance = external_resistance,
      max_force = max_force,
      max_velocity = max_velocity
    ),
    max_velocity = factor(max_velocity),
    max_force_label = factor(paste("Max force =", max_force))
  )

ggplot(
  velocity_reached,
  aes(
    x = external_resistance,
    y = velocity_reached,
    group = max_velocity,
    color = max_velocity
  )
) +
  theme_minimal() +
  geom_line() +
  facet_wrap(~max_force_label) +
  ylab("Velocity reached (m/s)") +
  xlab("External Force (N)")
```

The above represent *unconstrained*  **Force-Velocity profile** of the `Force Generator`. It is intrinsic (or latent) quality (characteristic or trait) of the `Force Generator` that can be *manifested* when `Force Generator` faces external resistance (force in Newtons) under *unconstrained* conditions (i.e. unlimited `Take-off Distance`). 

Unfortunately, the `Force Generator` behaves in the *constrained* environment, facing a particular *inertia* (bodyweight in this case) and limited distance over which that inertia can be accelerated (i.e. `Take-off Distance`). Plus, there are Force-Length and Force-Time characteristics that will affect performance in the *constrained* environment. 

How will these affect the *constrained*, or manifested, **Force-Velocity profile** of the `Force Generator`? This is what (among a few other things) we are interested in figuring out by using `vjsim` simulations. 

Before jumping to the simulation section, let's quickly review the parameters of the `Force Generator` and the simulation in general.

## List of Force Generator Parameters

Parameters of the system are the following:

- Mass (inertia) and weight ($mass \times 9.81$) represent external resistance to the `Force Generator`. These involve bodyweight and additional external load, such as extra weight (e.g. BW + 60kg). 

- `Take-off Distance,` or the limited distance over which the `Force Generator` can accelerate the mass object.

Parameters of the `Force Generator` involve the following:

- *Max Force*, which is the ultimate force that `Force Generator` can manifest in isometric conditions with 100% Force-Length relationship.

- *Max Velocity*, which is the ultimate velocity that `Force Generator` can manifest in *unconstrained* conditions (unlimited `Take-off Distance` and zero external resistance).

- *Max Force* and *Max Velocity* represent *unconstrained* Force-Velocity profile, or the Force-Velocity characteristic of the `Force Generator`.

- *Force-Length* characteristic of the `Force Generator` across `Take-off Distance`. This is characterized by three parameters: *start force*, *end force* (usually zero, since there is zero force at the moment of take-off) and *threshold* (which indicates at what %age of the `Take-off Distance` force begins to drop).

- *Force-Time* characteristic of the `Force Generator` that is represented by the *time to max force* parameter. *Initial force* represents the weight of the moving object (i.e. $(bodyweight + external \; load) \times 9.81$) since the vertical jumps starts from a dead start, and *potential force* is the maximal force that can be achieved at a particular point of `Take-off Distance` based on the Force-Length characteristic. For example at $d=0m$ and $t=0s$, *initial force* for 75kg bodyweight is equal to 735N, while *potential force* based on 80% Force-Length characteristic at $d=0$ and *max force* of 3,000N is equal to 2400N


These are all parameters that can be modified during the simulation.

# Simulation

# Profiles

# Shiny App

# References



